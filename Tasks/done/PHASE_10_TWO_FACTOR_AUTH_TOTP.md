# –§–∞–∑–∞ 10: –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (TOTP)

**–°—Ç–∞—Ç—É—Å:** üìã –°–ø–µ—Ü–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2
**–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã:** ~15-20 —á–∞—Å–æ–≤
**–¢–∏–ø:** TOTP (Time-based One-Time Password) ‚Äî —Å–æ–≤–º–µ—Å—Ç–∏–º —Å Google Authenticator, Authy, –Ø–Ω–¥–µ–∫—Å.–ö–ª—é—á, Aladdin 2FA

---

## –¶–µ–ª—å

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ –ª–æ–≥–∏–Ω–∞/–ø–∞—Ä–æ–ª—è –¥–æ–ª–∂–µ–Ω –≤–≤–µ—Å—Ç–∏ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞.

---

## –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ 2FA (–ø–µ—Ä–≤—ã–π —Ä–∞–∑)
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ–¥–∏—Ç –≤ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å"
2. –ù–∞–∂–∏–º–∞–µ—Ç "–í–∫–ª—é—á–∏—Ç—å 2FA"
3. –°–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç QR-–∫–æ–¥
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ (Google Authenticator –∏ —Ç.–ø.)
5. –í–≤–æ–¥–∏—Ç –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
6. 2FA –≤–∫–ª—é—á–µ–Ω–∞

### –í—Ö–æ–¥ —Å 2FA
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å
2. –ï—Å–ª–∏ 2FA –≤–∫–ª—é—á–µ–Ω–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª–µ "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
4. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥
5. –ï—Å–ª–∏ –≤–µ—Ä–Ω—ã–π ‚Äî –≤—ã–¥–∞—ë—Ç JWT —Ç–æ–∫–µ–Ω

---

## Backend

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–§–∞–π–ª:** `backend/pom.xml`

–î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:

```xml
<!-- TOTP –¥–ª—è 2FA -->
<dependency>
    <groupId>com.warrenstrange</groupId>
    <artifactId>googleauth</artifactId>
    <version>1.5.0</version>
</dependency>

<!-- QR-–∫–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è -->
<dependency>
    <groupId>com.google.zxing</groupId>
    <artifactId>core</artifactId>
    <version>3.5.2</version>
</dependency>
<dependency>
    <groupId>com.google.zxing</groupId>
    <artifactId>javase</artifactId>
    <version>3.5.2</version>
</dependency>
```

---

### –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

**–§–∞–π–ª:** `backend/src/main/resources/db/migration/V25__add_totp_fields.sql`

```sql
-- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –¥–ª—è TOTP 2FA
ALTER TABLE users ADD COLUMN IF NOT EXISTS totp_secret VARCHAR(64);
ALTER TABLE users ADD COLUMN IF NOT EXISTS totp_enabled BOOLEAN NOT NULL DEFAULT false;
ALTER TABLE users ADD COLUMN IF NOT EXISTS totp_enabled_at TIMESTAMP;

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX IF NOT EXISTS idx_users_totp_enabled ON users(totp_enabled) WHERE totp_enabled = true;

COMMENT ON COLUMN users.totp_secret IS '–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á TOTP (Base32)';
COMMENT ON COLUMN users.totp_enabled IS '–í–∫–ª—é—á–µ–Ω–∞ –ª–∏ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è';
COMMENT ON COLUMN users.totp_enabled_at IS '–ö–æ–≥–¥–∞ –±—ã–ª–∞ –≤–∫–ª—é—á–µ–Ω–∞ 2FA';
```

---

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ User Entity

**–§–∞–π–ª:** `backend/src/main/java/com/company/resourcemanager/entity/User.java`

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è:

```java
// === 2FA TOTP ===

@Column(name = "totp_secret", length = 64)
private String totpSecret;

@Column(name = "totp_enabled", nullable = false)
@Builder.Default
private Boolean totpEnabled = false;

@Column(name = "totp_enabled_at")
private LocalDateTime totpEnabledAt;

// –ì–µ—Ç—Ç–µ—Ä—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
public boolean isTotpEnabled() {
    return Boolean.TRUE.equals(totpEnabled);
}
```

---

### TotpService

**–§–∞–π–ª:** `backend/src/main/java/com/company/resourcemanager/service/TotpService.java`

```java
package com.company.resourcemanager.service;

import com.google.zxing.BarcodeFormat;
import com.google.zxing.client.j2se.MatrixToImageWriter;
import com.google.zxing.common.BitMatrix;
import com.google.zxing.qrcode.QRCodeWriter;
import com.warrenstrange.googleauth.GoogleAuthenticator;
import com.warrenstrange.googleauth.GoogleAuthenticatorKey;
import com.warrenstrange.googleauth.GoogleAuthenticatorQRGenerator;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.io.ByteArrayOutputStream;
import java.util.Base64;

@Service
@RequiredArgsConstructor
@Slf4j
public class TotpService {

    private final GoogleAuthenticator googleAuthenticator = new GoogleAuthenticator();

    @Value("${app.totp.issuer:Birzha}")
    private String issuer;

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è TOTP
     */
    public String generateSecret() {
        GoogleAuthenticatorKey key = googleAuthenticator.createCredentials();
        return key.getKey();
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–≤–µ–¥—ë–Ω–Ω—ã–π –∫–æ–¥
     */
    public boolean verifyCode(String secret, int code) {
        return googleAuthenticator.authorize(secret, code);
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–≤–µ–¥—ë–Ω–Ω—ã–π –∫–æ–¥ (—Å—Ç—Ä–æ–∫–∞)
     */
    public boolean verifyCode(String secret, String code) {
        try {
            int numericCode = Integer.parseInt(code.trim());
            return verifyCode(secret, numericCode);
        } catch (NumberFormatException e) {
            return false;
        }
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç URI –¥–ª—è QR-–∫–æ–¥–∞ (otpauth://...)
     */
    public String generateQrUri(String secret, String username) {
        return GoogleAuthenticatorQRGenerator.getOtpAuthTotpURL(
            issuer,
            username,
            new GoogleAuthenticatorKey.Builder(secret).build()
        );
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç QR-–∫–æ–¥ –∫–∞–∫ Base64 PNG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
     */
    public String generateQrCodeBase64(String secret, String username) {
        try {
            String qrUri = generateQrUri(secret, username);
            
            QRCodeWriter qrCodeWriter = new QRCodeWriter();
            BitMatrix bitMatrix = qrCodeWriter.encode(qrUri, BarcodeFormat.QR_CODE, 256, 256);
            
            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
            MatrixToImageWriter.writeToStream(bitMatrix, "PNG", outputStream);
            
            byte[] qrBytes = outputStream.toByteArray();
            return Base64.getEncoder().encodeToString(qrBytes);
        } catch (Exception e) {
            log.error("Failed to generate QR code", e);
            throw new RuntimeException("Failed to generate QR code", e);
        }
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç QR-–∫–æ–¥ –∫–∞–∫ Data URL (–¥–ª—è img src)
     */
    public String generateQrCodeDataUrl(String secret, String username) {
        String base64 = generateQrCodeBase64(secret, username);
        return "data:image/png;base64," + base64;
    }
}
```

---

### DTO –∫–ª–∞—Å—Å—ã

**–§–∞–π–ª:** `backend/src/main/java/com/company/resourcemanager/dto/TotpSetupResponse.java`

```java
package com.company.resourcemanager.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class TotpSetupResponse {
    private String secret;
    private String qrCodeDataUrl;
    private String manualEntryKey;
}
```

**–§–∞–π–ª:** `backend/src/main/java/com/company/resourcemanager/dto/TotpVerifyRequest.java`

```java
package com.company.resourcemanager.dto;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Pattern;
import lombok.Data;

@Data
public class TotpVerifyRequest {
    @NotBlank(message = "–ö–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω")
    @Pattern(regexp = "^\\d{6}$", message = "–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 6 —Ü–∏—Ñ—Ä")
    private String code;
}
```

**–§–∞–π–ª:** `backend/src/main/java/com/company/resourcemanager/dto/LoginResponse.java`

–ò–∑–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å:

```java
package com.company.resourcemanager.dto;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class LoginResponse {
    private String token;
    private boolean requiresTwoFactor;
    private String twoFactorToken;  // –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è 2FA
    private UserDto user;
}
```

---

### TwoFactorController

**–§–∞–π–ª:** `backend/src/main/java/com/company/resourcemanager/controller/TwoFactorController.java`

```java
package com.company.resourcemanager.controller;

import com.company.resourcemanager.dto.TotpSetupResponse;
import com.company.resourcemanager.dto.TotpVerifyRequest;
import com.company.resourcemanager.entity.User;
import com.company.resourcemanager.repository.UserRepository;
import com.company.resourcemanager.service.CurrentUserService;
import com.company.resourcemanager.service.TotpService;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.Map;

@RestController
@RequestMapping("/api/2fa")
@RequiredArgsConstructor
public class TwoFactorController {

    private final TotpService totpService;
    private final CurrentUserService currentUserService;
    private final UserRepository userRepository;

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å 2FA –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
     */
    @GetMapping("/status")
    public ResponseEntity<Map<String, Object>> getStatus() {
        User user = currentUserService.getCurrentUser();
        return ResponseEntity.ok(Map.of(
            "enabled", user.isTotpEnabled(),
            "enabledAt", user.getTotpEnabledAt() != null ? user.getTotpEnabledAt().toString() : null
        ));
    }

    /**
     * –ù–∞—á–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É 2FA ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Å–µ–∫—Ä–µ—Ç –∏ QR-–∫–æ–¥
     */
    @PostMapping("/setup")
    public ResponseEntity<TotpSetupResponse> setupTotp() {
        User user = currentUserService.getCurrentUser();
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Å–µ–∫—Ä–µ—Ç
        String secret = totpService.generateSecret();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ–∫—Ä–µ—Ç (–Ω–æ –ø–æ–∫–∞ –Ω–µ –≤–∫–ª—é—á–∞–µ–º 2FA)
        user.setTotpSecret(secret);
        userRepository.save(user);
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥
        String qrCodeDataUrl = totpService.generateQrCodeDataUrl(secret, user.getUsername());
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–µ–∫—Ä–µ—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ (–≥—Ä—É–ø–ø—ã –ø–æ 4 —Å–∏–º–≤–æ–ª–∞)
        String manualKey = secret.replaceAll("(.{4})", "$1 ").trim();
        
        return ResponseEntity.ok(TotpSetupResponse.builder()
            .secret(secret)
            .qrCodeDataUrl(qrCodeDataUrl)
            .manualEntryKey(manualKey)
            .build());
    }

    /**
     * –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É 2FA ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –∏ –≤–∫–ª—é—á–∏—Ç—å
     */
    @PostMapping("/enable")
    public ResponseEntity<Map<String, Object>> enableTotp(@Valid @RequestBody TotpVerifyRequest request) {
        User user = currentUserService.getCurrentUser();
        
        if (user.getTotpSecret() == null) {
            return ResponseEntity.badRequest().body(Map.of(
                "success", false,
                "message", "–°–Ω–∞—á–∞–ª–∞ –≤—ã–∑–æ–≤–∏—Ç–µ /setup –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–∞"
            ));
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
        if (!totpService.verifyCode(user.getTotpSecret(), request.getCode())) {
            return ResponseEntity.badRequest().body(Map.of(
                "success", false,
                "message", "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
            ));
        }
        
        // –í–∫–ª—é—á–∞–µ–º 2FA
        user.setTotpEnabled(true);
        user.setTotpEnabledAt(LocalDateTime.now());
        userRepository.save(user);
        
        return ResponseEntity.ok(Map.of(
            "success", true,
            "message", "–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω–∞"
        ));
    }

    /**
     * –û—Ç–∫–ª—é—á–∏—Ç—å 2FA (—Ç—Ä–µ–±—É–µ—Ç –≤–≤–æ–¥–∞ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–¥–∞)
     */
    @PostMapping("/disable")
    public ResponseEntity<Map<String, Object>> disableTotp(@Valid @RequestBody TotpVerifyRequest request) {
        User user = currentUserService.getCurrentUser();
        
        if (!user.isTotpEnabled()) {
            return ResponseEntity.badRequest().body(Map.of(
                "success", false,
                "message", "2FA –Ω–µ –≤–∫–ª—é—á–µ–Ω–∞"
            ));
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        if (!totpService.verifyCode(user.getTotpSecret(), request.getCode())) {
            return ResponseEntity.badRequest().body(Map.of(
                "success", false,
                "message", "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥"
            ));
        }
        
        // –û—Ç–∫–ª—é—á–∞–µ–º 2FA
        user.setTotpEnabled(false);
        user.setTotpSecret(null);
        user.setTotpEnabledAt(null);
        userRepository.save(user);
        
        return ResponseEntity.ok(Map.of(
            "success", true,
            "message", "–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞"
        ));
    }
}
```

---

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ AuthController

**–§–∞–π–ª:** `backend/src/main/java/com/company/resourcemanager/controller/AuthController.java`

–ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –ª–æ–≥–∏–Ω–∞:

```java
package com.company.resourcemanager.controller;

import com.company.resourcemanager.dto.*;
import com.company.resourcemanager.entity.User;
import com.company.resourcemanager.repository.UserRepository;
import com.company.resourcemanager.security.JwtTokenProvider;
import com.company.resourcemanager.service.TotpService;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.web.bind.annotation.*;

import java.util.Map;
import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;

@RestController
@RequestMapping("/api/auth")
@RequiredArgsConstructor
public class AuthController {

    private final AuthenticationManager authenticationManager;
    private final JwtTokenProvider jwtTokenProvider;
    private final UserRepository userRepository;
    private final TotpService totpService;

    // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤ 2FA (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis)
    private final Map<String, PendingTwoFactorAuth> pendingTwoFactorAuths = new ConcurrentHashMap<>();

    @PostMapping("/login")
    public ResponseEntity<?> login(@Valid @RequestBody LoginRequest request) {
        try {
            // –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å
            Authentication authentication = authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(request.getUsername(), request.getPassword())
            );

            User user = userRepository.findByUsername(request.getUsername())
                .orElseThrow(() -> new RuntimeException("User not found"));

            // –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–∞ –ª–∏ 2FA
            if (user.isTotpEnabled()) {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω
                String twoFactorToken = UUID.randomUUID().toString();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º pending auth (–∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç)
                pendingTwoFactorAuths.put(twoFactorToken, new PendingTwoFactorAuth(
                    user.getId(),
                    System.currentTimeMillis() + 5 * 60 * 1000
                ));
                
                // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
                cleanupExpiredTokens();
                
                return ResponseEntity.ok(LoginResponse.builder()
                    .requiresTwoFactor(true)
                    .twoFactorToken(twoFactorToken)
                    .build());
            }

            // –®–∞–≥ 3: 2FA –Ω–µ –Ω—É–∂–Ω–∞ ‚Äî –≤—ã–¥–∞—ë–º JWT —Å—Ä–∞–∑—É
            String token = jwtTokenProvider.createToken(user);
            
            return ResponseEntity.ok(LoginResponse.builder()
                .token(token)
                .requiresTwoFactor(false)
                .user(toUserDto(user))
                .build());

        } catch (AuthenticationException e) {
            return ResponseEntity.status(401).body(Map.of(
                "message", "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å"
            ));
        }
    }

    @PostMapping("/verify-2fa")
    public ResponseEntity<?> verifyTwoFactor(@RequestBody Map<String, String> request) {
        String twoFactorToken = request.get("twoFactorToken");
        String code = request.get("code");
        
        if (twoFactorToken == null || code == null) {
            return ResponseEntity.badRequest().body(Map.of(
                "message", "–¢—Ä–µ–±—É–µ—Ç—Å—è twoFactorToken –∏ code"
            ));
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º pending auth
        PendingTwoFactorAuth pending = pendingTwoFactorAuths.get(twoFactorToken);
        
        if (pending == null) {
            return ResponseEntity.status(401).body(Map.of(
                "message", "–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ."
            ));
        }
        
        if (pending.expiresAt < System.currentTimeMillis()) {
            pendingTwoFactorAuths.remove(twoFactorToken);
            return ResponseEntity.status(401).body(Map.of(
                "message", "–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ."
            ));
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        User user = userRepository.findById(pending.userId)
            .orElseThrow(() -> new RuntimeException("User not found"));
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º TOTP –∫–æ–¥
        if (!totpService.verifyCode(user.getTotpSecret(), code)) {
            return ResponseEntity.status(401).body(Map.of(
                "message", "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
            ));
        }
        
        // –£–¥–∞–ª—è–µ–º pending auth
        pendingTwoFactorAuths.remove(twoFactorToken);
        
        // –í—ã–¥–∞—ë–º JWT
        String token = jwtTokenProvider.createToken(user);
        
        return ResponseEntity.ok(LoginResponse.builder()
            .token(token)
            .requiresTwoFactor(false)
            .user(toUserDto(user))
            .build());
    }

    @GetMapping("/me")
    public ResponseEntity<?> getCurrentUser(Authentication authentication) {
        if (authentication == null) {
            return ResponseEntity.status(401).body(Map.of("message", "Not authenticated"));
        }
        
        User user = userRepository.findByUsername(authentication.getName())
            .orElseThrow(() -> new RuntimeException("User not found"));
        
        return ResponseEntity.ok(toUserDto(user));
    }

    private UserDto toUserDto(User user) {
        return UserDto.builder()
            .id(user.getId())
            .username(user.getUsername())
            .email(user.getEmail())
            .roles(user.getRolesList())
            .dzoId(user.getDzo() != null ? user.getDzo().getId() : null)
            .dzoName(user.getDzo() != null ? user.getDzo().getName() : null)
            .totpEnabled(user.isTotpEnabled())
            .build();
    }

    private void cleanupExpiredTokens() {
        long now = System.currentTimeMillis();
        pendingTwoFactorAuths.entrySet().removeIf(e -> e.getValue().expiresAt < now);
    }

    // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–ª–∞—Å—Å –¥–ª—è pending auth
    private record PendingTwoFactorAuth(Long userId, long expiresAt) {}
}
```

---

### –û–±–Ω–æ–≤–∏—Ç—å UserDto

**–§–∞–π–ª:** `backend/src/main/java/com/company/resourcemanager/dto/UserDto.java`

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ:

```java
private boolean totpEnabled;
```

---

### Security Config

**–§–∞–π–ª:** `backend/src/main/java/com/company/resourcemanager/config/SecurityConfig.java`

–î–æ–±–∞–≤–∏—Ç—å –≤ permitAll:

```java
.requestMatchers("/api/auth/login", "/api/auth/verify-2fa").permitAll()
```

---

## Frontend

### API –º–æ–¥—É–ª—å

**–§–∞–π–ª:** `frontend/src/api/twoFactor.js`

```javascript
import client from './client'

export const twoFactorApi = {
  // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å 2FA
  getStatus() {
    return client.get('/2fa/status')
  },

  // –ù–∞—á–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É ‚Äî –ø–æ–ª—É—á–∏—Ç—å QR-–∫–æ–¥
  setup() {
    return client.post('/2fa/setup')
  },

  // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∏ –≤–∫–ª—é—á–∏—Ç—å 2FA
  enable(code) {
    return client.post('/2fa/enable', { code })
  },

  // –û—Ç–∫–ª—é—á–∏—Ç—å 2FA
  disable(code) {
    return client.post('/2fa/disable', { code })
  },

  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
  verify(twoFactorToken, code) {
    return client.post('/auth/verify-2fa', { twoFactorToken, code })
  }
}
```

---

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ auth store

**–§–∞–π–ª:** `frontend/src/stores/auth.js`

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É 2FA:

```javascript
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import client from '@/api/client'
import { twoFactorApi } from '@/api/twoFactor'

export const useAuthStore = defineStore('auth', () => {
  const user = ref(null)
  const token = ref(localStorage.getItem('token'))
  const loading = ref(false)
  
  // –î–ª—è 2FA
  const pendingTwoFactor = ref(null)  // { twoFactorToken }

  const isAuthenticated = computed(() => !!token.value && !!user.value)
  const isAdmin = computed(() => user.value?.roles?.some(r => 
    ['SYSTEM_ADMIN', 'DZO_ADMIN'].includes(r)
  ))
  const isSystemAdmin = computed(() => user.value?.roles?.includes('SYSTEM_ADMIN'))
  const isTotpEnabled = computed(() => user.value?.totpEnabled || false)

  async function login(username, password) {
    loading.value = true
    try {
      const response = await client.post('/auth/login', { username, password })
      
      if (response.data.requiresTwoFactor) {
        // –ù—É–∂–Ω–∞ 2FA ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –∂–¥—ë–º –∫–æ–¥
        pendingTwoFactor.value = {
          twoFactorToken: response.data.twoFactorToken
        }
        return { requiresTwoFactor: true }
      }
      
      // 2FA –Ω–µ –Ω—É–∂–Ω–∞ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
      token.value = response.data.token
      user.value = response.data.user
      localStorage.setItem('token', response.data.token)
      client.defaults.headers.common['Authorization'] = `Bearer ${response.data.token}`
      
      return { success: true }
    } finally {
      loading.value = false
    }
  }

  async function verifyTwoFactor(code) {
    if (!pendingTwoFactor.value) {
      throw new Error('No pending 2FA')
    }
    
    loading.value = true
    try {
      const response = await twoFactorApi.verify(
        pendingTwoFactor.value.twoFactorToken,
        code
      )
      
      // –£—Å–ø–µ—à–Ω–æ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
      token.value = response.data.token
      user.value = response.data.user
      localStorage.setItem('token', response.data.token)
      client.defaults.headers.common['Authorization'] = `Bearer ${response.data.token}`
      
      pendingTwoFactor.value = null
      
      return { success: true }
    } finally {
      loading.value = false
    }
  }

  function cancelTwoFactor() {
    pendingTwoFactor.value = null
  }

  async function fetchUser() {
    if (!token.value) return
    
    try {
      client.defaults.headers.common['Authorization'] = `Bearer ${token.value}`
      const response = await client.get('/auth/me')
      user.value = response.data
    } catch (error) {
      logout()
    }
  }

  function logout() {
    token.value = null
    user.value = null
    pendingTwoFactor.value = null
    localStorage.removeItem('token')
    delete client.defaults.headers.common['Authorization']
  }

  return {
    user,
    token,
    loading,
    pendingTwoFactor,
    isAuthenticated,
    isAdmin,
    isSystemAdmin,
    isTotpEnabled,
    login,
    verifyTwoFactor,
    cancelTwoFactor,
    fetchUser,
    logout
  }
})
```

---

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ LoginView

**–§–∞–π–ª:** `frontend/src/views/LoginView.vue`

–î–æ–±–∞–≤–∏—Ç—å —à–∞–≥ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ 2FA:

```vue
<template>
  <div class="login-view">
    <div class="login-card glass-card">
      <div class="logo">
        <div class="logo-icon">B</div>
        <h1>Birzha</h1>
      </div>

      <!-- –®–∞–≥ 1: –õ–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å -->
      <el-form 
        v-if="!showTwoFactor"
        ref="formRef"
        :model="form"
        :rules="rules"
        @submit.prevent="handleLogin"
      >
        <el-form-item prop="username">
          <el-input 
            v-model="form.username" 
            placeholder="–õ–æ–≥–∏–Ω"
            prefix-icon="User"
            size="large"
          />
        </el-form-item>

        <el-form-item prop="password">
          <el-input 
            v-model="form.password" 
            type="password" 
            placeholder="–ü–∞—Ä–æ–ª—å"
            prefix-icon="Lock"
            size="large"
            show-password
          />
        </el-form-item>

        <el-button 
          type="primary" 
          native-type="submit" 
          :loading="authStore.loading"
          size="large"
          class="login-btn"
        >
          –í–æ–π—Ç–∏
        </el-button>
      </el-form>

      <!-- –®–∞–≥ 2: –ö–æ–¥ 2FA -->
      <div v-else class="two-factor-form">
        <div class="two-factor-icon">
          <el-icon :size="48"><Key /></el-icon>
        </div>
        <h2>–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h2>
        <p class="two-factor-hint">–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞</p>
        
        <el-input
          v-model="twoFactorCode"
          placeholder="000000"
          maxlength="6"
          size="large"
          class="two-factor-input"
          @keyup.enter="handleVerifyTwoFactor"
        />

        <div class="two-factor-actions">
          <el-button 
            type="primary" 
            :loading="authStore.loading"
            :disabled="twoFactorCode.length !== 6"
            size="large"
            class="login-btn"
            @click="handleVerifyTwoFactor"
          >
            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
          </el-button>
          <el-button 
            text 
            @click="handleCancelTwoFactor"
          >
            –û—Ç–º–µ–Ω–∞
          </el-button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage } from 'element-plus'
import { Key } from '@element-plus/icons-vue'
import { useAuthStore } from '@/stores/auth'

const router = useRouter()
const authStore = useAuthStore()

const formRef = ref(null)
const form = ref({
  username: '',
  password: ''
})

const twoFactorCode = ref('')

const showTwoFactor = computed(() => !!authStore.pendingTwoFactor)

const rules = {
  username: [{ required: true, message: '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω', trigger: 'blur' }],
  password: [{ required: true, message: '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å', trigger: 'blur' }]
}

async function handleLogin() {
  const valid = await formRef.value.validate().catch(() => false)
  if (!valid) return

  try {
    const result = await authStore.login(form.value.username, form.value.password)
    
    if (result.requiresTwoFactor) {
      // –ù—É–∂–Ω–∞ 2FA ‚Äî —Ñ–æ—Ä–º–∞ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
      twoFactorCode.value = ''
      return
    }
    
    if (result.success) {
      router.push('/')
    }
  } catch (error) {
    ElMessage.error(error.response?.data?.message || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏')
  }
}

async function handleVerifyTwoFactor() {
  if (twoFactorCode.value.length !== 6) return

  try {
    const result = await authStore.verifyTwoFactor(twoFactorCode.value)
    
    if (result.success) {
      router.push('/')
    }
  } catch (error) {
    ElMessage.error(error.response?.data?.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥')
    twoFactorCode.value = ''
  }
}

function handleCancelTwoFactor() {
  authStore.cancelTwoFactor()
  twoFactorCode.value = ''
  form.value.password = ''
}
</script>

<style scoped>
/* ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ ... */

.two-factor-form {
  text-align: center;
}

.two-factor-icon {
  color: var(--accent, #7c3aed);
  margin-bottom: 16px;
}

.two-factor-form h2 {
  font-size: 20px;
  margin: 0 0 8px 0;
  color: var(--text-primary);
}

.two-factor-hint {
  color: var(--text-muted);
  font-size: 14px;
  margin-bottom: 24px;
}

.two-factor-input {
  margin-bottom: 24px;
}

.two-factor-input :deep(.el-input__inner) {
  text-align: center;
  font-size: 24px;
  letter-spacing: 8px;
  font-family: monospace;
}

.two-factor-actions {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
</style>
```

---

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ 2FA

**–§–∞–π–ª:** `frontend/src/components/TwoFactorSetup.vue`

```vue
<template>
  <div class="two-factor-setup">
    <!-- –°—Ç–∞—Ç—É—Å -->
    <div class="status-section">
      <div class="status-indicator" :class="{ enabled: authStore.isTotpEnabled }">
        <el-icon><Lock /></el-icon>
      </div>
      <div class="status-text">
        <h3>–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h3>
        <p v-if="authStore.isTotpEnabled" class="enabled">–í–∫–ª—é—á–µ–Ω–∞</p>
        <p v-else class="disabled">–û—Ç–∫–ª—é—á–µ–Ω–∞</p>
      </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è -->
    <div v-if="!showSetup">
      <el-button 
        v-if="!authStore.isTotpEnabled"
        type="primary"
        @click="startSetup"
      >
        –í–∫–ª—é—á–∏—Ç—å 2FA
      </el-button>
      <el-button 
        v-else
        type="danger"
        @click="showDisableDialog = true"
      >
        –û—Ç–∫–ª—é—á–∏—Ç—å 2FA
      </el-button>
    </div>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ -->
    <div v-if="showSetup" class="setup-section">
      <div class="setup-steps">
        <div class="step">
          <div class="step-number">1</div>
          <div class="step-content">
            <h4>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h4>
            <p>–°–∫–∞—á–∞–π—Ç–µ Google Authenticator, Authy –∏–ª–∏ –Ø–Ω–¥–µ–∫—Å.–ö–ª—é—á –Ω–∞ —Å–≤–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω</p>
          </div>
        </div>

        <div class="step">
          <div class="step-number">2</div>
          <div class="step-content">
            <h4>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥</h4>
            <div class="qr-container" v-if="setupData">
              <img :src="setupData.qrCodeDataUrl" alt="QR Code" class="qr-code" />
            </div>
            <p class="manual-key" v-if="setupData">
              –ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –≤—Ä—É—á–Ω—É—é: <code>{{ setupData.manualEntryKey }}</code>
            </p>
          </div>
        </div>

        <div class="step">
          <div class="step-number">3</div>
          <div class="step-content">
            <h4>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h4>
            <el-input
              v-model="verifyCode"
              placeholder="000000"
              maxlength="6"
              class="verify-input"
            />
            <div class="step-actions">
              <el-button type="primary" :loading="loading" @click="confirmSetup">
                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
              </el-button>
              <el-button @click="cancelSetup">–û—Ç–º–µ–Ω–∞</el-button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –î–∏–∞–ª–æ–≥ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è -->
    <el-dialog v-model="showDisableDialog" title="–û—Ç–∫–ª—é—á–∏—Ç—å 2FA" width="400px">
      <p>–î–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:</p>
      <el-input
        v-model="disableCode"
        placeholder="000000"
        maxlength="6"
        class="disable-input"
      />
      <template #footer>
        <el-button @click="showDisableDialog = false">–û—Ç–º–µ–Ω–∞</el-button>
        <el-button type="danger" :loading="loading" @click="confirmDisable">
          –û—Ç–∫–ª—é—á–∏—Ç—å
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref } from 'vue'
import { ElMessage } from 'element-plus'
import { Lock } from '@element-plus/icons-vue'
import { useAuthStore } from '@/stores/auth'
import { twoFactorApi } from '@/api/twoFactor'

const authStore = useAuthStore()

const showSetup = ref(false)
const setupData = ref(null)
const verifyCode = ref('')
const loading = ref(false)

const showDisableDialog = ref(false)
const disableCode = ref('')

async function startSetup() {
  loading.value = true
  try {
    const response = await twoFactorApi.setup()
    setupData.value = response.data
    showSetup.value = true
  } catch (error) {
    ElMessage.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ 2FA')
  } finally {
    loading.value = false
  }
}

async function confirmSetup() {
  if (verifyCode.value.length !== 6) {
    ElMessage.warning('–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥')
    return
  }
  
  loading.value = true
  try {
    const response = await twoFactorApi.enable(verifyCode.value)
    if (response.data.success) {
      ElMessage.success('2FA —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω–∞!')
      showSetup.value = false
      setupData.value = null
      verifyCode.value = ''
      // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      await authStore.fetchUser()
    }
  } catch (error) {
    ElMessage.error(error.response?.data?.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥')
  } finally {
    loading.value = false
  }
}

function cancelSetup() {
  showSetup.value = false
  setupData.value = null
  verifyCode.value = ''
}

async function confirmDisable() {
  if (disableCode.value.length !== 6) {
    ElMessage.warning('–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥')
    return
  }
  
  loading.value = true
  try {
    const response = await twoFactorApi.disable(disableCode.value)
    if (response.data.success) {
      ElMessage.success('2FA –æ—Ç–∫–ª—é—á–µ–Ω–∞')
      showDisableDialog.value = false
      disableCode.value = ''
      await authStore.fetchUser()
    }
  } catch (error) {
    ElMessage.error(error.response?.data?.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥')
  } finally {
    loading.value = false
  }
}
</script>

<style scoped>
.two-factor-setup {
  padding: 20px;
}

.status-section {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
}

.status-indicator {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
}

.status-indicator.enabled {
  background: rgba(16, 185, 129, 0.2);
  color: #10b981;
}

.status-text h3 {
  margin: 0;
  font-size: 16px;
  color: var(--text-primary);
}

.status-text p {
  margin: 4px 0 0;
  font-size: 14px;
}

.status-text p.enabled {
  color: #10b981;
}

.status-text p.disabled {
  color: #ef4444;
}

.setup-section {
  margin-top: 24px;
  padding-top: 24px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.setup-steps {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.step {
  display: flex;
  gap: 16px;
}

.step-number {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--accent, #7c3aed);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  flex-shrink: 0;
}

.step-content h4 {
  margin: 0 0 8px;
  color: var(--text-primary);
}

.step-content p {
  margin: 0;
  color: var(--text-secondary);
  font-size: 14px;
}

.qr-container {
  margin: 16px 0;
}

.qr-code {
  width: 200px;
  height: 200px;
  border-radius: 8px;
  background: white;
  padding: 8px;
}

.manual-key {
  margin-top: 12px;
}

.manual-key code {
  background: rgba(124, 58, 237, 0.2);
  padding: 4px 8px;
  border-radius: 4px;
  font-family: monospace;
  color: var(--accent);
}

.verify-input {
  max-width: 200px;
  margin-bottom: 16px;
}

.verify-input :deep(.el-input__inner) {
  text-align: center;
  font-size: 20px;
  letter-spacing: 4px;
}

.step-actions {
  display: flex;
  gap: 12px;
}

.disable-input {
  margin-top: 16px;
}

.disable-input :deep(.el-input__inner) {
  text-align: center;
  font-size: 20px;
  letter-spacing: 4px;
}
</style>
```

---

### –î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è

–í —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Ä–∞–∑–¥–µ–ª "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å" –∏ –¥–æ–±–∞–≤–∏—Ç—å:

```vue
<TwoFactorSetup />
```

---

## API Endpoints

| –ú–µ—Ç–æ–¥ | URL | –û–ø–∏—Å–∞–Ω–∏–µ | –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è |
|-------|-----|----------|-------------|
| POST | `/api/auth/login` | –õ–æ–≥–∏–Ω (—à–∞–≥ 1) | –ù–µ—Ç |
| POST | `/api/auth/verify-2fa` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ 2FA (—à–∞–≥ 2) | –ù–µ—Ç |
| GET | `/api/2fa/status` | –°—Ç–∞—Ç—É—Å 2FA | –î–∞ |
| POST | `/api/2fa/setup` | –ù–∞—á–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É (–ø–æ–ª—É—á–∏—Ç—å QR) | –î–∞ |
| POST | `/api/2fa/enable` | –í–∫–ª—é—á–∏—Ç—å 2FA | –î–∞ |
| POST | `/api/2fa/disable` | –û—Ç–∫–ª—é—á–∏—Ç—å 2FA | –î–∞ |

---

## –§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è

### Backend (9 —Ñ–∞–π–ª–æ–≤)

| # | –§–∞–π–ª | –î–µ–π—Å—Ç–≤–∏–µ |
|---|------|----------|
| 1 | `pom.xml` | –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ |
| 2 | `V25__add_totp_fields.sql` | –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é |
| 3 | `User.java` | –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è |
| 4 | `TotpService.java` | –°–æ–∑–¥–∞—Ç—å |
| 5 | `TotpSetupResponse.java` | –°–æ–∑–¥–∞—Ç—å |
| 6 | `TotpVerifyRequest.java` | –°–æ–∑–¥–∞—Ç—å |
| 7 | `LoginResponse.java` | –ò–∑–º–µ–Ω–∏—Ç—å/—Å–æ–∑–¥–∞—Ç—å |
| 8 | `TwoFactorController.java` | –°–æ–∑–¥–∞—Ç—å |
| 9 | `AuthController.java` | –ò–∑–º–µ–Ω–∏—Ç—å |

### Frontend (4 —Ñ–∞–π–ª–∞)

| # | –§–∞–π–ª | –î–µ–π—Å—Ç–≤–∏–µ |
|---|------|----------|
| 1 | `api/twoFactor.js` | –°–æ–∑–¥–∞—Ç—å |
| 2 | `stores/auth.js` | –ò–∑–º–µ–Ω–∏—Ç—å |
| 3 | `views/LoginView.vue` | –ò–∑–º–µ–Ω–∏—Ç—å |
| 4 | `components/TwoFactorSetup.vue` | –°–æ–∑–¥–∞—Ç—å |

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å: `docker-compose build`
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å: `docker-compose up -d`
3. –í–æ–π—Ç–∏ –ø–æ–¥ admin/admin123
4. –û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
5. –í–∫–ª—é—á–∏—Ç—å 2FA:
   - –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥ –≤ Google Authenticator
   - –í–≤–µ—Å—Ç–∏ –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ 2FA –≤–∫–ª—é—á–µ–Ω–∞
6. –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
7. –í–æ–π—Ç–∏ —Å–Ω–æ–≤–∞:
   - –í–≤–µ—Å—Ç–∏ –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å
   - –ü–æ—è–≤–∏—Ç—Å—è –ø–æ–ª–µ –¥–ª—è –∫–æ–¥–∞
   - –í–≤–µ—Å—Ç–∏ –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ 2FA
